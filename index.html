<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcane ODM Trainer | Outskirts</title>
    <style>
        :root {
            --neon-blue: #00d4ff;
            --neon-green: #2ecc71;
            --neon-red: #e74c3c;
            --glass-bg: rgba(10, 15, 25, 0.95);
            --glass-border: rgba(0, 212, 255, 0.4);
        }

        body {
            font-family: 'Orbitron', sans-serif;
            margin: 0; padding: 0;
            display: flex; justify-content: center; align-items: center;
            background: #05080a url('bg.png') no-repeat center center fixed;
            background-size: cover;
            color: #e0e0e0; min-height: 100vh; overflow: hidden;
        }

        /* --- AUTH SYSTEM --- */
        #auth-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            z-index: 100; display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(20px);
        }
        .auth-box {
            background: var(--glass-bg); padding: 40px; border: 1px solid var(--glass-border);
            border-radius: 15px; text-align: center; width: 320px; box-shadow: 0 0 50px rgba(0,212,255,0.2);
        }

        /* --- HUD --- */
        .hud-container { display: flex; flex-direction: row; gap: 20px; padding: 20px; z-index: 5; }
        #controls-left, #controls-right {
            display: flex; flex-direction: column; background: var(--glass-bg);
            padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px); width: 250px;
        }
        .canvas-wrapper { border: 2px solid var(--glass-border); background: #000; position: relative; }

        button, select, input {
            margin: 5px 0; padding: 12px; font-family: 'Orbitron'; text-transform: uppercase;
            background: rgba(0, 212, 255, 0.05); color: #fff; border: 1px solid var(--glass-border);
            cursor: pointer; transition: 0.2s; font-size: 11px;
        }
        button:hover { background: rgba(0, 212, 255, 0.2); box-shadow: 0 0 15px var(--neon-blue); }
        
        /* --- DEV TOOLS --- */
        #dev-btn { display: none; background: #ff0055; border-color: #ff0055; font-weight: bold; }
        #dev-panel { display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: #1a0000; border: 2px solid #ff0055; padding: 20px; z-index: 60; border-radius: 10px; width: 280px; }

        /* --- CREDITS --- */
        #creditsContent { display: none; padding: 10px 0; border-top: 1px solid var(--glass-border); margin-top: 5px; font-size: 10px; }
        .name-kraaxen { color: var(--neon-blue); font-weight: bold; }
        .name-damter { color: var(--neon-green); font-weight: bold; }
        .name-cuternest { color: var(--neon-red); font-weight: bold; }

        #leaderboard-panel {
            position: fixed; right: -350px; top: 0; width: 300px; height: 100%;
            background: var(--glass-bg); border-left: 2px solid var(--glass-border);
            z-index: 50; padding: 40px 20px; transition: 0.4s;
            overflow-y: auto;
        }
        #leaderboard-panel.active { right: 0; }
        .rank-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(0, 212, 255, 0.1); }

        #sync-meter { font-size: 24px; color: var(--neon-green); text-align: center; margin-bottom: 10px; }
        .user-info { border-bottom: 1px solid var(--glass-border); margin-bottom: 15px; padding-bottom: 10px; position: relative; }
        #status-indicator { font-size: 10px; text-align: center; margin-top: 5px; letter-spacing: 1px; }

        canvas { display: block; cursor: crosshair; }
        #user-banner { width: 100%; margin-top: auto; border: 1px solid var(--glass-border); border-radius: 4px; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>

<div id="auth-overlay">
    <div class="auth-box">
        <h2 style="color: var(--neon-blue);">USER ACCESS</h2>
        <input type="text" id="usernameInput" placeholder="USERNAME">
        <input type="password" id="passwordInput" placeholder="PASSWORD">
        <button onclick="handleAuth('login')">Login</button>
        <button onclick="handleAuth('signup')" style="font-size: 9px; border:none; background:none;">Create Account</button>
        <button onclick="guestPlay()" style="margin-top: 20px; opacity: 0.6;">Play as Guest</button>
    </div>
</div>

<div id="dev-panel">
    <h3 style="color: #ff0055; margin-top: 0;">KRAAXEN DEV CONSOLE</h3>
    <button onclick="devKillAll()" style="width:100%">INSTANT PURGE (KILL ALL)</button>
    <hr style="border:0; border-top:1px solid #440000; margin: 10px 0;">
    <input type="text" id="banUserInput" placeholder="USERNAME TO BAN" style="width: 80%;">
    <button onclick="devBanUser()" style="background: #440000; width:100%">BAN MEMBER</button>
    <hr style="border:0; border-top:1px solid #440000; margin: 10px 0;">
    <button onclick="devResetDatabase()" style="background: red; width:100%">WIPE GLOBAL MISSIONS</button>
    <button onclick="document.getElementById('dev-panel').style.display='none'" style="width:100%">CLOSE</button>
</div>

<div id="leaderboard-panel">
    <button onclick="toggleLB()" style="width: 40px; margin-bottom: 20px;">X</button>
    <h2 style="color: var(--neon-blue);">GLOBAL TOP USERS</h2>
    <div id="lb-list">Loading Global Data...</div>
</div>

<div class="hud-container">
    <div id="controls-left">
        <button id="dev-btn" onclick="document.getElementById('dev-panel').style.display='block'">[DEV TOOLS]</button>
        <div class="user-info">
            <button onclick="signOut()" style="position: absolute; right: 0; top: 0; padding: 2px 5px; font-size: 8px; width: auto;">Sign Out</button>
            <span style="font-size: 10px; color: var(--neon-blue);">USER:</span><br>
            <span id="display-name" style="font-weight: 900; font-size: 18px;">GUEST</span><br>
            <span style="font-size: 10px;">MISSIONS: <span id="display-missions" style="color:var(--neon-green)">0</span></span>
        </div>
        <button onclick="undo()">Undo Path</button>
        <button onclick="clearPathsOnly()">Clear Paths</button>
        <button onclick="generate()" style="color: var(--neon-green); border-color: var(--neon-green);">New Mission</button>
        <button onclick="toggleLB()" style="color: gold; border-color: gold;">Leaderboard</button>

        <div style="margin-top: 15px;">
            <button id="creditsBtn" onclick="toggleCredits()">▼ Credits</button>
            <div id="creditsContent">
                <span class="name-kraaxen">kraaxeN</span> - idea and coding<br>
                <span class="name-damter">Damter</span> - grid design and fun ideas<br>
                <span class="name-cuternest">Cuternest</span> - map design
            </div>
        </div>
    </div>

    <div class="canvas-wrapper">
        <div id="sync-meter">SYNC: <span id="sync-val">0</span>%</div>
        <canvas id="map" width="800" height="800"></canvas>
        <div id="status-indicator">SYSTEM READY</div>
    </div>

    <div id="controls-right">
        <button id="modeBtn" onclick="toggleMode()">Mode: ODM</button>
        <select id="titanType">
            <option value="basic">Basic Titan</option>
            <option value="abnormal">Abnormal Titan</option>
        </select>
        <button onclick="createBlankMap()" style="border-color: var(--neon-red); color: var(--neon-red);">Create Blank Map</button>
        <button onclick="toggleGrid()">Toggle Grid</button>
        
        <a href="https://www.youtube.com/@kraaxeN" target="_blank" style="margin-top: auto;">
            <img src="kraxbanner.png" id="user-banner" alt="Banner">
        </a>
    </div>
</div>

<script>
    const BIN_ID = 'REPLACE_WITH_YOUR_BIN_ID'; 
    const MASTER_KEY = 'REPLACE_WITH_YOUR_MASTER_KEY';
    const dbKey = 'arcane_odm_data';

    let currentUser = null;
    let isCheatMode = false;
    let globalData = {};

    async function syncGlobalData(push = false) {
        if (!MASTER_KEY.includes('REPLACE')) {
            try {
                if (push) {
                    await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'X-Master-Key': MASTER_KEY },
                        body: JSON.stringify(globalData)
                    });
                } else {
                    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                        headers: { 'X-Master-Key': MASTER_KEY }
                    });
                    const json = await res.json();
                    globalData = json.record;
                    localStorage.setItem(dbKey, JSON.stringify(globalData));
                }
            } catch (e) { console.error("Sync Failed", e); }
        } else {
            globalData = JSON.parse(localStorage.getItem(dbKey) || '{}');
        }
    }

    const spawnPolygon = [
        {x: 270, y: 40},  {x: 740, y: 70},  {x: 770, y: 350}, 
        {x: 780, y: 600}, {x: 620, y: 700}, {x: 350, y: 680},
        {x: 180, y: 640}, {x: 90, y: 450}, {x: 140, y: 300},
        {x: 220, y: 120}
    ];

    function isPointInPoly(pt, poly) {
        let isInside = false;
        for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
            if (((poly[i].y > pt.y) !== (poly[j].y > pt.y)) &&
                (pt.x < (poly[j].x - poly[i].x) * (pt.y - poly[i].y) / (poly[j].y - poly[i].y) + poly[i].x)) {
                isInside = !isInside;
            }
        }
        return isInside;
    }

    function getRandomPointInPoly(poly) {
        let pt = {x: 0, y: 0};
        let found = false;
        while (!found) {
            pt.x = Math.random() * 800;
            pt.y = Math.random() * 800;
            if (isPointInPoly(pt, poly)) found = true;
        }
        return pt;
    }

    async function handleAuth(type) {
        const u = document.getElementById('usernameInput').value.trim();
        const p = document.getElementById('passwordInput').value.trim();
        if(!u || !p) return alert("Fill fields");
        await syncGlobalData(); 
        if(globalData[u] && globalData[u].banned) return alert("YOU ARE BANNED.");
        if(type === 'signup') {
            if(globalData[u]) return alert("Exists");
            globalData[u] = { password: p, missions: 0, banned: false };
            await syncGlobalData(true);
            alert("Account Created!");
        } else {
            if(!globalData[u] || globalData[u].password !== p) return alert("Wrong credentials");
            currentUser = u;
            document.getElementById('display-name').textContent = u.toUpperCase();
            document.getElementById('display-missions').textContent = globalData[u].missions;
            document.getElementById('auth-overlay').style.display = 'none';
            if(u === 'kraaxen' && p === '123456') {
                document.getElementById('dev-btn').style.display = 'block';
            }
        }
    }

    function devKillAll() {
        titans.forEach(t => t.dead = true);
        document.getElementById('sync-val').textContent = "100";
        checkKill([]);
    }

    async function devBanUser() {
        const target = document.getElementById('banUserInput').value.trim();
        if(!target) return;
        if(globalData[target]) {
            globalData[target].banned = true;
            await syncGlobalData(true);
            alert(target + " banned.");
        } else { alert("Not found."); }
    }

    async function devResetDatabase() {
        if(confirm("WIPE GLOBAL DATA?")) {
            globalData = {};
            await syncGlobalData(true);
            location.reload();
        }
    }

    function guestPlay() { document.getElementById('auth-overlay').style.display = 'none'; }
    function signOut() { location.reload(); }

    async function toggleLB() {
        const p = document.getElementById('leaderboard-panel');
        p.classList.toggle('active');
        if(p.classList.contains('active')) {
            document.getElementById('lb-list').innerHTML = "Fetching...";
            await syncGlobalData();
            const sorted = Object.entries(globalData)
                .filter(([name, data]) => !data.banned)
                .sort((a,b) => b[1].missions - a[1].missions);
            document.getElementById('lb-list').innerHTML = sorted.map(([name, data], i) => `
                <div class="rank-item"><span>${i+1}. ${name}</span><span style="color:var(--neon-green)">${data.missions}</span></div>
            `).join('');
        }
    }

    function toggleCredits() {
        const c = document.getElementById('creditsContent');
        const b = document.getElementById('creditsBtn');
        const isVis = c.style.display === 'block';
        c.style.display = isVis ? 'none' : 'block';
        b.textContent = isVis ? '▼ Credits' : '▲ Credits';
    }

    const canvas = document.getElementById('map');
    const ctx = canvas.getContext('2d');
    const imgs = { map: new Image(), basic: new Image(), abnormal: new Image(), skull: new Image(), grid: new Image() };
    imgs.map.src = 'outskirts.png'; imgs.basic.src = 'basic.png';
    imgs.abnormal.src = 'abnormal.png'; imgs.skull.src = 'skull.png'; imgs.grid.src = 'grid.png';

    let titans = [], paths = [], currentPath = [], drawing = false, grid = true, customMode = false;

    function generate() {
        isCheatMode = false;
        drawing = false; // RESET DRAWING STATE
        paths = []; 
        currentPath = []; 
        document.getElementById('status-indicator').textContent = "CADET MISSION ACTIVE";
        document.getElementById('status-indicator').style.color = "var(--neon-green)";
        titans = [];
        for(let i=0; i<40; i++) {
            let pos = getRandomPointInPoly(spawnPolygon);
            let type = Math.random() < 0.8 ? 'basic' : 'abnormal';
            titans.push({ x: pos.x, y: pos.y, type: type, dead: false, float: 20 });
        }
        document.getElementById('sync-val').textContent = '0';
    }

    function createBlankMap() {
        isCheatMode = true;
        drawing = false;
        document.getElementById('status-indicator').textContent = "PRACTICE MODE (NO SCORE)";
        document.getElementById('status-indicator').style.color = "var(--neon-red)";
        titans = []; paths = []; currentPath = [];
        document.getElementById('sync-val').textContent = '0';
        if(!customMode) toggleMode();
    }

    function distToSeg(p, v, w) {
        const l2 = Math.pow(v.x-w.x, 2) + Math.pow(v.y-w.y, 2);
        if(l2 == 0) return Math.hypot(p.x-v.x, p.y-v.y);
        let t = ((p.x-v.x)*(w.x-v.x) + (p.y-v.y)*(w.y-v.y))/l2;
        t = Math.max(0, Math.min(1, t));
        return Math.hypot(p.x-(v.x+t*(w.x-v.x)), p.y-(v.y+t*(w.y-v.y)));
    }

    async function checkKill(seg) {
        const p1 = seg.length >= 2 ? seg[seg.length-2] : null;
        const p2 = seg.length >= 2 ? seg[seg.length-1] : null;
        titans.forEach(t => {
            if(!t.dead && p1 && p2 && distToSeg(t, p1, p2) < 20) { t.dead = true; }
        });
        const killed = titans.filter(x => x.dead).length;
        const perc = titans.length > 0 ? Math.floor((killed/titans.length)*100) : 0;
        document.getElementById('sync-val').textContent = perc;

        if(perc === 100 && currentUser && !isCheatMode && titans.length > 0) {
            drawing = false; // FORCE DRAWING OFF BEFORE ALERT
            globalData[currentUser].missions++;
            await syncGlobalData(true);
            document.getElementById('display-missions').textContent = globalData[currentUser].missions;
            alert("MISSION COMPLETE!");
            generate();
        }
    }

    function draw() {
        ctx.clearRect(0,0,800,800);
        ctx.drawImage(imgs.map, 0, 0, 800, 800);
        if(grid) ctx.drawImage(imgs.grid, 0, 0, 800, 800);
        
        const killedCount = titans.filter(x => x.dead).length;
        if(killedCount === 0 && titans.length > 0) {
            ctx.fillStyle = "rgba(0, 212, 255, 0.1)";
            ctx.fillRect(0, 700, 800, 100);
        }

        titans.forEach(t => {
            ctx.drawImage(t.type === 'basic' ? imgs.basic : imgs.abnormal, t.x-20, t.y-20, 40, 40);
            if(t.dead) {
                if(t.float > 0) t.float -= 1.5;
                ctx.save(); ctx.shadowBlur = 15; ctx.shadowColor = 'red';
                ctx.drawImage(imgs.skull, t.x-15, t.y-15 + t.float, 30, 30); ctx.restore();
            }
        });
        ctx.strokeStyle = '#00d4ff'; ctx.lineWidth = 3;
        [...paths, currentPath].forEach(p => {
            if(p.length < 2) return;
            ctx.beginPath(); ctx.moveTo(p[0].x, p[0].y);
            p.forEach(pt => ctx.lineTo(pt.x, pt.y)); ctx.stroke();
        });
        requestAnimationFrame(draw);
    }

    canvas.onmousedown = (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left, y = e.clientY - rect.top;
        if(customMode) {
            isCheatMode = true;
            titans.push({x, y, type: document.getElementById('titanType').value, dead: false, float: 0});
        } else { 
            const killedCount = titans.filter(t => t.dead).length;
            if(killedCount === 0 && titans.length > 0 && y < 700) {
                document.getElementById('status-indicator').textContent = "LOCKED: START FROM BOTTOM SECTOR";
                setTimeout(() => { if(!isCheatMode) document.getElementById('status-indicator').textContent = "CADET MISSION ACTIVE"; }, 2000);
                return;
            }
            drawing = true; 
            currentPath = [{x, y}]; 
        }
    };
    canvas.onmousemove = (e) => { 
        if(drawing) { 
            const r = canvas.getBoundingClientRect(); 
            currentPath.push({x: e.clientX - r.left, y: e.clientY - r.top}); 
            checkKill(currentPath); 
        } 
    };

    // GLOBAL MOUSE UP FIX
    window.addEventListener('mouseup', () => {
        if(drawing) {
            paths.push([...currentPath]);
            drawing = false;
            currentPath = [];
        }
    });

    function undo() { paths.pop(); titans.forEach(t => t.dead = false); document.getElementById('sync-val').textContent = '0'; }
    function clearPathsOnly() { paths = []; titans.forEach(t => t.dead = false); document.getElementById('sync-val').textContent = '0'; }
    function toggleGrid() { grid = !grid; }
    function toggleMode() { 
        customMode = !customMode; 
        document.getElementById('modeBtn').textContent = customMode ? "Mode: Placement" : "Mode: ODM";
    }
    
    syncGlobalData().then(() => {
        imgs.map.onload = () => { generate(); draw(); };
    });
</script>
</body>
</html>
